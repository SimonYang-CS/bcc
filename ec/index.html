<!doctype html>
<html>

	<head>
		<meta charset="utf8">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="viewport" content="initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
		<title>Theta | EC</title>
	</head>

	<body style="margin:0; overflow: hidden;">
		<noscript>This application requires JavaScript.</noscript>
		<!--script src="compiled.mod.js"></script-->

		<script>
			let EC

			const mem = new WebAssembly.Memory({ initial: 5, maximum: 5 })
			const baseaddr = new WebAssembly.Global({value:'i32', mutable:false}, 0);
			const sp = new WebAssembly.Global({value:'i32', mutable: true}, 2048);
			const importObj = {
			    env: {
			        //abortStackOverflow: () => { throw new Error('overflow'); },table: new WebAssembly.Table({ initial: 0, maximum: 0, element: 'anyfunc' }),tableBase: 0,
			        memory: mem,
			        __memory_base: baseaddr,
			        __stack_pointer: sp,
			        iprintf: function() {console.log('printf',arguments)},
			        putchar: function() {console.log('putchar',arguments)}
			    }
			}

			const FP = (base,offset,hex) => { /*var bytes = new Uint8Array(32);*/ for (var i = 0; i < 64; i++) base[offset+i] = parseInt(hex.substr(i * 2, 2),16) /* return bytes */}
			const dump = (M, offset) => {console.log(offset)
 					var hex = '', g, i = 0
					for (; i < 32; i++) {
						g = M[offset + i]
						if (g < 16) hex += '0'
						hex += g.toString(16)
						//console.log(M[sp.value + offset + i])
					}
					console.log(hex)
				}

			WebAssembly.instantiateStreaming(fetch('e.wasm'), importObj)
				.then(w => {
					EC = w.instance.exports
					const m32 = mem.buffer
					var M = new Uint8Array(mem.buffer)
					//console.log(sp.value)
					//console.log(sp.value)


/*
char*A_PRI="77076d0a7318a57d3c16c17251b26645df4c2f87ebc0992ab177fba51db92c2a",//alice
    *A_PUB="8520f0098930a754748b7ddcb43ef75a0dbf3a0d26381af4eba4a98eaa9b4e6a",
    *B_PRI="5dab087e624a8a4b79e17f8b83800ee66f3bb1292618b6fd1c2f8b27ff88e0eb",//bob
    *B_PUB="de9edb7d7b7dc1b4d35b61c2ece435373f8343c85b78674dadfc7e146f882b4f",
    *AB_SK="4a5d9d5ba4ce2de1728e3bf480350f25e07e21c947d19e3376f09b3c1e161742";//shared
*/

    //*A_PUB="8520f0098930a754748b7ddcb43ef75a0dbf3a0d26381af4eba4a98eaa9b4e6a",
    //*B_PRI="5dab087e624a8a4b79e17f8b83800ee66f3bb1292618b6fd1c2f8b27ff88e0eb",//
					// rfc7748
					const A_PRI="5dab087e624a8a4b79e17f8b83800ee66f3bb1292618b6fd1c2f8b27ff88e0eb" //alice
					const B_PUB="8520f0098930a754748b7ddcb43ef75a0dbf3a0d26381af4eba4a98eaa9b4e6a"

					//FP(M, 351+16, A_PRI)
					//FP(M, 351+32, B_PUB)
					//dump(M, 351)
					//FP(M, 351+32, B_PUB)

					//const encoder = new TextEncoder()
					//const view = encoder.encode('Hello DEV')
					//console.log(view); // Uint8Array

					//var res = new Uint8Array(32)

					FP(M, sp.value-32, A_PRI)
					FP(M, sp.value-64, B_PUB)

					dump(M, sp.value-32)
					//dump(M, sp.value-64)

					//sp.value -= 64


					//EC.xshared(351, 351+16, 351+32)
					EC.xshared()

					//dump(M, sp.value-16)
					//dump(M, sp.value-32)
					//dump(M, 351+32)

					//const A_PRI="de9edb7d7b7dc1b4d35b61c2ece435373f8343c85b78674dadfc7e146f882b4f" //alice
					//const B_PUB="8520f0098930a754748b7ddcb43ef75a0dbf3a0d26381af4eba4a98eaa9b4e6a"


					//FP(M, 0, A_PRI)
					//FP(M, 16, B_PUB)

					//FP(M, 0 + 32, A_PRI)
					//FP(M, 0 + 64, B_PUB)

					//dump(M, sp.value + 0)
					//dump(M, 0)
					//dump(M, 16)
					//dump(M, 32)

					//console.log('----------------')
					//for (var i = 0; i < 32; i++) console.log(M[sp.value + i])

					//EC.xkeygen(sp.value, sp.value + 32, sp.value + 64)
					//var res = EC.xshared(32, 0, 16)
					//console.log('res',res)

					//for (var i = 0; i < 32; i++) console.log(M[sp.value + i])

					//dump(M, 0)
					//dump(M, 16)
					//dump(M, 32)


			})

		</script>

	</body>

</html>


